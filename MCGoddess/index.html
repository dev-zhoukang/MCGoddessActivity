<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta content="email=no" name="format-detection">
    <title>æ’è¡Œæ¦œ</title>
    <link rel="stylesheet" href="lib/mui/css/mui.css">
    <link rel="stylesheet" href="css/index.css">
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="lib/mui/js/mui.min.js"></script>
</head>
<body>

<!--åœ¨è¿™é‡Œ, mainæ ‡ç­¾çš„æ„ä¹‰ä»…ä»…æ˜¯æ’‘å¼€ç›’å­, æŠŠsubpageæ”¾åœ¨é‡Œé¢(ä¸æ˜¯çœŸæ­£æ”¾åœ¨é‡Œé¢, æ˜¯iframeå½¢å¼)-->
<main>

    <div id="rule-view" class="zk-modal">
        <div class="zk-modal-content">
            <p class="content">
            <h2 class="title">å¥–å“è®¾ç½®</h2>
            1, ç¬¬ä¸€åå°†è£è†ºâ€œæ‘©æ“¦2016å¹´åº¦å¥³ç‹â€ç§°å·ï¼ŒåŒæ—¶è·èµ ğŸ“±iphone7ä¸€å°ï¼<br>
            2, ç¬¬äºŒåå°†ä¼šè·èµ å°ç§˜ä¹¦é€å‡ºçš„9999æœµé²œèŠ±ï¼<br>
            3, ç¬¬ä¸‰åå°†ä¼šè·å¾—å°ç§˜ä¹¦é€å‡ºçš„999æœµé²œèŠ±ï¼<br>
            </p>
            <p class="content bottom-para">
            <h2 class="title">æ´»åŠ¨è§„åˆ™</h2>
            1, è§†é¢‘è®¤è¯ç”¨æˆ·å‡å¯æŠ¥åï¼Œç‚¹å‡»â€œæˆ‘è¦æŠ¥åâ€ç«‹å³å‚ä¸ï¼<br>
            2, æŠ¥åæˆåŠŸçš„ç”¨æˆ·ä¼šå‡ºç°åœ¨å‚é€‰åå•å†…ã€‚<br>
            3, æ¯æœµé²œèŠ±å¯ä»¥ä¸ºå¥³ç¥ç‚¹äº®ä¸€æ¬¡ã€‚<br>
            4.å¥–å“è¯„é€‰ä»¥æ­¤æ´»åŠ¨æ’åä¸ºå”¯ä¸€ä¾æ®ã€‚<br>
            5, æ´»åŠ¨æˆªæ­¢æ—¶é—´ä¸º2017å¹´1æœˆ3æ—¥24ç‚¹æ•´ã€‚<br>
            6, æœ‰ç–‘é—®è¯·è”ç³»å®¢æœï¼š028-65789575ã€‚<br>
            </p>
        </div>
    </div>

    <div id="pullrefresh" class="mui-content mui-scroll-wrapper zk-scroll-wrapper">
        <div class="mui-scroll">
            <canvas id="canvas" class="firework"></canvas>
            <header class="mui-clearfix">
                <div class="title-img">
                    <img class="left" src="imgs/icon-star.jpg" alt="" width="40" height="40">
                    <img class="right rotate" src="imgs/icon-star.jpg" alt="" width="25" height="25">
                </div>
                <div class="event-container mui-clearfix">
                    <a class="btn-event float-left" href="javascript:;" id="btn-signup">ç«‹å³æŠ¥å</a>
                    <a class="btn-event float-right" href="javascript:;" id="btn-rule">æ´»åŠ¨è§„åˆ™</a>
                </div>
                <div class="searchbar-container">
                    <div class="wrapper">
                        <img src="imgs/icon-search.png" alt="" width="20" height="20">
                        <form action="" onsubmit="return false">
                            <input id="search-bar" type="search" placeholder="è¾“å…¥æ‘©æ“¦IDæˆ–æ˜µç§° å¿«é€Ÿç‚¹äº®">
                        </form>
                    </div>
                </div>
            </header>
            <!--æ•°æ®åˆ—è¡¨-->
            <ul id="list-container" class="mui-table-view mui-table-view-chevron list-container">
                <!--<li class="rank-cell border-bottom">-->
                <!--<div class="rank-num-view">2</div>-->
                <!--<div class="user-avatar-view"></div>-->
                <!--<div class="detail-container">-->
                <!--<p class="nickname">ä¸‰å¶è‰</p>-->
                <!--<p id="text" class="mocaID"><em></em>æ‘©æ“¦ID: 34444322</p>-->
                <!--<p class="sign">ä¸ªæ€§ç­¾å: ä¸–ç•Œä¸Šæœ¬æ²¡æœ‰è·¯, èµ°çš„äººå¤šäº†, å°±æˆä¸ºäº†è·¯</p>-->
                <!--</div>-->
                <!--<div class="lighten-container">-->
                <!--<p class="lighten-num">232</p>-->
                <!--<a id="btn-lighten" href="javascript:;" class="btn-lighten" data-id="htet">ç‚¹äº®</a>-->
                <!--</div>-->
                <!--</li>-->
            </ul>
        </div>

        <!--<div class="rank-cell border-bottom my-cell">-->
        <!--<div class="rank-num-view">2</div>-->
        <!--<div class="user-avatar-view"></div>-->
        <!--<div class="detail-container">-->
        <!--<p class="nickname">ä¸‰å¶è‰</p>-->
        <!--<p id="text" class="mocaID"><em></em>æ‘©æ“¦ID: 34444322</p>-->
        <!--<p class="sign">ä¸ªæ€§ç­¾å: ä¸–ç•Œä¸Šæœ¬æ²¡æœ‰è·¯, èµ°çš„äººå¤šäº†, å°±æˆä¸ºäº†è·¯</p>-->
        <!--</div>-->
        <!--<div class="lighten-container">-->
        <!--<p class="lighten-num">232</p>-->
        <!--<a id="btn-lighten" href="javascript:;" class="btn-lighten" data-id="htet">ç‚¹äº®</a>-->
        <!--</div>-->
        <!--</div>-->
    </div>

    <div id="popover" class="mui-popover popover mui-clearfix">
        <div class="flower-num">
            <a href="javascript:;" data-num="1">ç‚¹äº®1æ¬¡</a>
        </div>
        <div class="flower-num">
            <a href="javascript:;" data-num="11">ç‚¹äº®11æ¬¡</a>
        </div>
        <div class="flower-num">
            <a href="javascript:;" data-num="99">ç‚¹äº®99æ¬¡</a>
        </div>
        <div class="flower-num">
            <a href="javascript:;" data-num="520">ç‚¹äº®520æ¬¡</a>
        </div>
    </div>

    <div class="flower-drop">

    </div>

</main>

<script src="js/zk-firework.js"></script>
<script src="js/base.js"></script>
<script>
    var toUID = null,
            toNickname = null,
            fromUID = null,
            authStatus = 0,
            $tableView = $('.mui-table-view'),
            hasSignup = false,
            currentPage = 1,
            myKeyword = '';

    setupMUI();
    /*è‡ªåŠ¨åˆ·æ–°*/
    mui.ready(function() {
        requestNewData(true);
        //mui('#pullrefresh').pullRefresh().pulldownLoading();
    });

    $().ready(function () {
        bindRuleBtn();
        setupUI();
    });

    function connectWebViewJavascriptBridge(callback) {
        if (window.WebViewJavascriptBridge) {
            callback(WebViewJavascriptBridge)
        } else {
            document.addEventListener('WebViewJavascriptBridgeReady', function() {
                callback(WebViewJavascriptBridge)
            }, false)
        }
    }
    connectWebViewJavascriptBridge(function(bridge) {
        bridge.init();

//        $(function () {
            bridge.callHandler('UserInfo', {}, function(d) {
                if (typeof d == 'string') {
                    d = JSON.parse(d);
                }
                console.log(d);
                fromUID = d.uid;
                authStatus = d.auth_status;
                initData();
            });
//        })
    });

    function initData() {
        getSignupState();
        bindSendFlowerBtn();
    }

    /**
     * ä¸Šæ‹‰ä¸‹æ‹‰åˆ·æ–° åŠ è½½æ•°æ® æ›´æ–°é¡µé¢
     **/
    function updateMineCell(oriModel) {
        var p = {};
        p.nick = oriModel.nickname;
        p.avatar = oriModel.avatar;
        p.uid = oriModel.uid;
        p.sign = 'ä¸ªæ€§ç­¾å: ' + oriModel.signature;
        p.rankNum = oriModel.first_few;
        p.receiveNum = oriModel.lighting;

        updateCellWithModel(p,true);
    }

    function pullupRefresh() {
        currentPage ++;
        myKeyword = '';
        requestNewData(false);
    }

    function pulldownRefresh() {
        currentPage = 1;
        myKeyword = '';
        requestNewData(true);
        if (hasSignup) {
            $.ajax({
                url: baseUlr + 'moca/NewYear/Ranking',
                type: 'POST',
                data: {
                    keyword: fromUID,
                    page: currentPage
                },
                success: function (d) {

                    if (typeof d == 'string') {
                        d = JSON.parse(d);
                    }
                    if (!d.data[0]) {
                        return;
                    }
                    var oriModel = d.data[0];
                    updateMineCell(oriModel);
                }
            });
        }
    }

    function requestNewData(isPulldown) {
        $.ajax({
            url: baseUlr + 'moca/NewYear/Ranking',
            type: 'POST',
            data: {
                keyword: myKeyword,
                page: currentPage
            },
            success: function (d) {

                !!isPulldown && $tableView.empty();

                if (typeof d == 'string') {
                    d = JSON.parse(d);
                }

                var dataList = [];

                $.each(d.data, function (index, obj) {
                    var p = {};
                    p.nick = obj.nickname;
                    p.avatar = obj.avatar;
                    p.uid = obj.uid;
                    p.sign = 'ä¸ªæ€§ç­¾å: ' + obj.signature;
                    p.rankNum = obj.first_few;
                    p.receiveNum = obj.lighting;
                    dataList.push(p);
                });

                updateUIWithDataList(dataList);
                setTimeout(function () {

                    isPulldown?mui('#pullrefresh').pullRefresh().endPulldownToRefresh()
                              :mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
                    //isPulldown && mui('#pullrefresh').pullRefresh().refresh(true);
                }, 200);
            },
            error: function (data) {
                mui('#pullrefresh').pullRefresh().endPulldownToRefresh(); //refresh completed
                mui('#pullrefresh').pullRefresh().endPullupToRefresh(true); // trueä»£è¡¨æ²¡æœ‰æ›´å¤šæ•°æ®äº†
            }
        });
    }

    function bindEventForLightenBtn() {
        var $elems = $('.btn-lighten');
        $elems.each(function (index, obj) {
            obj.addEventListener('tap', function () {
                var to = $(obj).attr('data-id');
                toNickname = $(obj).attr('data-nick');
                toUID = to;
                console.log(to);
                mui('.mui-popover').popover('show', obj);
            })
        })
    }

    /**
     * æ›´æ–°UIé¡µé¢
     */
    function updateUIWithDataList(dataList) {
        for (var i = 0; i < dataList.length; i++) {

            var model = dataList[i];

            updateCellWithModel(model,false);
        }
        bindEventForLightenBtn();
    }

    function exchangeRankNumBg($view, rankNum) {
        $view.empty();
        rankNum == 1 && $view.css('background', 'url("imgs/icon-gold-medal.png") no-repeat top center / 53px 60px');
        rankNum == 2 && $view.css('background', 'url("imgs/icon-silver-medal.png") no-repeat top center / 53px 60px');
        rankNum == 3 && $view.css('background', 'url("imgs/icon-copper-medal.png") no-repeat top center / 53px 60px');
    }

    function updateCellWithModel(model, isMine) {
        var $cell = $('<li class="rank-cell border-bottom"></li>');
        var $rankNumView = $('<div class="rank-num-view">'+ model.rankNum +'</div>');
        parseInt(model.rankNum) <= 3 && exchangeRankNumBg($rankNumView, parseInt(model.rankNum));

        var $avatarView = $('<div class="user-avatar-view"></div>');
        $avatarView.css({
            'background': 'url('+ model.avatar +') no-repeat top center / 55px 55px',
        });

        var $detail = $('<div class="detail-container"></div>');
        var $nick = $('<p class="nickname">'+ model.nick +'</p>');
        var $mocaid = $('<p id="text" class="mocaID"><em></em>æ‘©æ“¦ID:'+ model.uid +'</p>');
        var $sign = $('<p class="sign">'+ model.sign +'</p>');
        $detail.append($nick).append($mocaid).append($sign);

        var lightenView = $('<div class="lighten-container"></div>');
        var lightenNum = $('<p class="lighten-num">'+ model.receiveNum +'</p>');
        var lightenBtn = $('<a id="btn-lighten" href="javascript:;" class="btn-lighten" data-id="'+ model.uid +'" data-nick="'+ model.nick +'">ç‚¹äº®</a>');
        lightenView.append(lightenNum).append(lightenBtn);

        $cell.append($rankNumView).append($avatarView).append($detail).append(lightenView);
        if (isMine) {

            var oriMyCell = $('.zk-scroll-wrapper .my-cell');
            if (oriMyCell.get(0)) {
                oriMyCell.animate({
                    'bottom': '-100px'
                }, 180, function () {
                    oriMyCell.remove();
                });
            }

            $cell.addClass('my-cell').addClass('border-top').css({
                'bottom': '-100px'
            });
            $('.zk-scroll-wrapper').append($cell);
            $cell.delay(666).animate({
                'bottom': 0
            }, 250)
        }
        else {
            $tableView.append($cell);
        }
    }

    /**
     * ç‚¹å‡»æœç´¢
     */
    $("body").keyup(function () {
        if (event.which == 13){
            startSearch();
        }
    });
    $('#search-bar').on('input propertychange', function () {
        startSearch();
    });
    function startSearch() {
        var keyword = $('#search-bar').val();
        myKeyword = keyword;
        currentPage = 1;
        requestNewData(true);
    }

    /**
     * åˆå§‹åŒ–é¡µé¢
     */
    function bindSendFlowerBtn() {
        $('.flower-num a').each(function (index, obj) {
            obj.addEventListener('tap', function () {
                mui('.mui-popover').popover('hide');
                var flowerNum = $(obj).attr('data-num');

                if (fromUID == toUID) {
                    mui.alert('è‡ªå·±ä¸èƒ½ç»™è‡ªå·±é€èŠ±å“¦', 'æç¤º', 'æˆ‘çŸ¥é“äº†');
                    return;
                }

                loading.show();
                //alert('é€èŠ±==>' + fromUID + 'ä¸º' + toUID + 'ç‚¹äº®' + flowerNum + 'æ¬¡');

                // å‘é€è¯·æ±‚é€èŠ±
                $.ajax({
                    url: baseUlr + 'moca/NewYear/Flowers',
                    type: 'POST',
                    data: {
                        uid: fromUID,
                        to_uid: toUID,
                        num: flowerNum
                    },

                    success: function (response) {
                        loading.hide();
                        if (typeof response == 'string') {
                            response = JSON.parse(response);
                        }

                        if (response.result == 1) {
                            var winInfo = response.data.win_alert_info;
                            var hintStr = 'æ‚¨å·²ç»æˆåŠŸä¸º'+ toNickname +'ç‚¹äº®'+ flowerNum +'æ¬¡';
                            mui.alert(hintStr, 'æç¤º', 'å¥½çš„');
                            setTimeout(function () {
                                if (!winInfo) {
                                    return;
                                }
                                mui.alert(winInfo, 'ä¸­å¥–å•¦!', 'çŸ¥é“äº†');
                                var $flowerDrop = $('.flower-drop');
                                $flowerDrop.css('display', 'block').animate({
                                    'top': '1000px'
                                }, 2200, function () {
                                    $flowerDrop.css({
                                        'top': '-1000px',
                                        'display': 'none',
                                    });
                                })
                            }, 300);

                            if (currentPage != 1) {
                                mui('#pullrefresh').scroll().scrollTo(0,0,250);
                                setTimeout(function () {
                                    mui('#pullrefresh').pullRefresh().pulldownLoading();
                                }, 250);
                            }
                            else {
                                requestNewData(true);
                            }

                            console.log('é€èŠ±æˆåŠŸ==>' + fromUID + 'ä¸º' + toUID + 'ç‚¹äº®' + flowerNum + 'æ¬¡');
                        }
                        else {
                            response.msg && mui.alert(response.msg, 'æç¤º', 'å¥½çš„');
                        }
                    },
                    error: function (response) {
                        loading.hide();
                        if (typeof response == 'string') {
                            response = JSON.parse(response);
                        }
                        response.msg && mui.alert(response.msg, 'æç¤º', 'å¥½çš„');
                    }
                });
            });
        });
    }
    function bindRuleBtn() {
        var $ruleView = $('#rule-view');
        var $modalContent = $('.zk-modal-content');
        $('#btn-rule').get(0).addEventListener('tap', function () {
            console.log('ç‚¹å‡»è§„åˆ™');
            $ruleView.css('display', 'block');
            $modalContent.removeClass('modal-out').addClass('modal-in');
        });

        $ruleView.get(0).addEventListener('tap', function () {
            $modalContent.removeClass('modal-in').addClass('modal-out');
            setTimeout(function () {
                $ruleView.css('display', 'none');
            }, 250);
        });
    }
    function bindSignBtn() {
        $('#btn-signup').get(0).addEventListener('tap', function () {

            if (!fromUID) {
                return false;
            }
            if (hasSignup) {
                mui.alert('å·²ç»æŠ¥åè¿‡, æ— éœ€é‡å¤æŠ¥å! \nåœ¨æ’è¡Œæ¦œåº•æ å¯ä»¥çœ‹åˆ°è‡ªå·±çš„æ’åä¿¡æ¯', 'æç¤º', 'æˆ‘çŸ¥é“äº†');
                return;
            }
            if (authStatus != 1) {
                mui.alert('è§†é¢‘è®¤è¯ä¹‹åæ‰å¯ä»¥å‚ä¸æ´»åŠ¨å‘¦~', 'æç¤º', 'æˆ‘çŸ¥é“äº†');
                return;
            }
            console.log('ç‚¹å‡»æŠ¥å');

            loading.show();
            setTimeout(function () {
                $.ajax({
                    url: baseUlr + 'moca/NewYear/Signup',
                    type: 'POST',
                    data: {
                        uid: fromUID
                    },
                    success: function (response) {
                        if (typeof response == 'string') {
                            response = JSON.parse(response);
                        }

                        if (response.result == 1) {
                            mui.alert('åœ¨æ’è¡Œæ¦œåº•æ å¯ä»¥çœ‹åˆ°è‡ªå·±çš„æ’åä¿¡æ¯', 'æŠ¥åæˆåŠŸ!', 'å¥½çš„');
                            updateMineCell(response.data);
                        }
                        else {
                            var msgStr = typeof response.data === 'string' ? response.data : 'æŠ¥åå¤±è´¥, è¯·ä»”ç»†æŸ¥çœ‹æŠ¥åè§„åˆ™';
                            mui.alert(msgStr, 'æŠ¥åå¤±è´¥', 'å¥½çš„');
                        }
                    },
                    complete: function () {
                        loading.hide();
                    }
                })
            }, 500);
        });
    }
    function setupUI() {
        var headerHeight = $('header').height();
        $('#list-container').css({
            'marginTop': headerHeight
        });
    }
    function setupMUI() {
        mui.init({
            pullRefresh: {
                container: '#pullrefresh',
                down: {
                    contentdown: 'ä¸‹æ‹‰åˆ·æ–°æœ€æ–°æ’è¡Œæ¦œ',
                    callback: pulldownRefresh
                },
                up: {
                    contentrefresh: 'æ­£åœ¨åŠ è½½...',
                    contentnomore: 'å·²ç»åŠ è½½å…¨éƒ¨æ’è¡Œæ¦œæ•°æ®',
                    callback: pullupRefresh
                }
            },
            gestureConfig:{
                tap: true, //é»˜è®¤ä¸ºtrue
                doubletap: true, //é»˜è®¤ä¸ºfalse
                longtap: true, //é»˜è®¤ä¸ºfalse
                swipe: true, //é»˜è®¤ä¸ºtrue
                drag: true, //é»˜è®¤ä¸ºtrue
                hold:false,//é»˜è®¤ä¸ºfalseï¼Œä¸ç›‘å¬
                release:false//é»˜è®¤ä¸ºfalseï¼Œä¸ç›‘å¬
            }
        });
    }
    function getSignupState() {
        $.ajax({
            url: baseUlr + 'moca/NewYear/GetSignup',
            type: 'POST',
            data: {
                uid: fromUID
            },
            success: function (response) {
                if (typeof response == 'string') {
                    response = JSON.parse(response);
                }

                if (response.data.length == 0) {
                    hasSignup = false;
                }
                else {
                    hasSignup = true;
                    // å¦‚æœå·²ç»æŠ¥å åº•éƒ¨é»˜è®¤æ˜¾ç¤ºè‡ªå·±çš„æ’åä¿¡æ¯
                    var oriModel = response.data;
                    updateMineCell(oriModel);
                }
                bindSignBtn();
            },
            error: function (response) {

            }
        })
    }

</script>

</body>
</html>